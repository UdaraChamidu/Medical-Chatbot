<!DOCTYPE html>
<html lang="en" data-theme="light">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>AI Doctor Assistant</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  </head>
  <body class="bg-gray-50 text-gray-800 font-sans">
    <div class="max-w-4xl mx-auto px-6 py-12">
      <!-- Header -->
      <header class="text-center mb-10">
        <h1 class="text-4xl font-bold text-indigo-700 mb-2">AI Doctor Assistant</h1>
        <p class="text-gray-600">Upload an image and ask a medical question</p>
      </header>

      <!-- Form Section -->
      <div class="bg-white p-6 rounded-xl shadow-md">
        <div class="mb-4">
          <label class="block font-semibold text-sm mb-2">Upload Image</label>
          <input type="file" id="image-upload" accept="image/*" class="block w-full text-sm text-gray-700" />
          <div id="image-container" class="hidden mt-4">
            <img id="display-image" src="" alt="Uploaded Image" class="rounded-lg shadow border max-w-full" />
          </div>
        </div>

        <div class="mb-4">
          <label class="block font-semibold text-sm mb-2">Describe Your Symptoms or Ask a Question</label>
          <textarea id="query-input" rows="4" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-400"></textarea>
        </div>

        <button id="submit-query" class="w-full py-3 bg-indigo-600 hover:bg-indigo-700 text-white font-semibold rounded-lg flex items-center justify-center gap-2">
          <span>Submit</span>
          <div id="loading-spinner" class="hidden animate-spin rounded-full h-5 w-5 border-t-2 border-white"></div>
        </button>

        <!-- Error Display -->
        <div id="error-container" class="hidden mt-4 p-3 bg-red-100 text-red-800 border border-red-300 rounded">
          <p id="error-text"></p>
        </div>

        <!-- Response Display -->
        <div id="response-container" class="hidden mt-6 p-4 bg-gray-100 text-gray-800 rounded border border-gray-300 text-sm whitespace-pre-wrap"></div>
      </div>
    </div>

    <script>
      document.addEventListener("DOMContentLoaded", function () {
        const imageUpload = document.getElementById("image-upload");
        const displayImage = document.getElementById("display-image");
        const imageContainer = document.getElementById("image-container");
        const queryInput = document.getElementById("query-input");
        const submitQuery = document.getElementById("submit-query");
        const spinner = document.getElementById("loading-spinner");
        const responseContainer = document.getElementById("response-container");
        const errorContainer = document.getElementById("error-container");
        const errorText = document.getElementById("error-text");

        imageUpload.addEventListener("change", (event) => {
          const file = event.target.files[0];
          if (file) {
            const reader = new FileReader();
            reader.onload = (e) => {
              displayImage.src = e.target.result;
              imageContainer.classList.remove("hidden");
            };
            reader.readAsDataURL(file);
          }
        });

        submitQuery.addEventListener("click", async () => {
          const image = imageUpload.files[0];
          const query = queryInput.value.trim();

          if (!image || !query) {
            showError("Please upload an image and enter a question.");
            return;
          }

          const formData = new FormData();
          formData.append("image", image);
          formData.append("query", query);

          try {
            submitQuery.disabled = true;
            spinner.classList.remove("hidden");

            const response = await fetch("/upload_and_query", {
              method: "POST",
              body: formData,
            });

            const result = await response.json();

            if (!response.ok) throw new Error(result.detail || "Unknown server error.");

            responseContainer.innerHTML = marked.parse(result.llama);
            responseContainer.classList.remove("hidden");
            errorContainer.classList.add("hidden");
          } catch (error) {
            console.error(error);
            showError(error.message);
          } finally {
            submitQuery.disabled = false;
            spinner.classList.add("hidden");
          }
        });

        function showError(message) {
          errorText.textContent = message;
          errorContainer.classList.remove("hidden");
          responseContainer.classList.add("hidden");
        }
      });
    </script>
  </body>
</html>